{% extends "base.html" %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Honeypot Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css" rel="stylesheet">


  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }

    body {
      background-color: #0e141b;
      color: #ffffff;
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 240px;
      background-color: #111820;
      height: 100vh;
      padding: 20px;
      position: fixed;
    }

    .sidebar h1 {
      font-size: 22px;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul li {
      padding: 12px 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
    }

    .sidebar ul li:hover,
    .sidebar ul li.active {
      background-color: #1d2630;
    }

    .main {
      flex: 1;
      padding: 20px;
      margin-left: 240px;
      width: calc(100% - 240px);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background-color: #1d2630;
      padding: 20px;
      border-radius: 12px;
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card h4 {
      margin-bottom: 10px;
      font-size: 14px;
      color: #a0aec0;
    }

    .card p {
      font-size: 24px;
      font-weight: 600;
    }

    .section {
      background-color: #1d2630;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .section h3 {
      margin-bottom: 15px;
      font-size: 18px;
    }

    .honeypots-table,
    .attackers-table {
      width: 100%;
      border-collapse: collapse;
    }

    .honeypots-table th,
    .honeypots-table td,
    .attackers-table th,
    .attackers-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #2d3748;
    }

    .honeypots-table th,
    .attackers-table th {
      color: #a0aec0;
      font-weight: 600;
      font-size: 14px;
    }

    .honeypots-table tbody tr:hover {
      background-color: #2d3748;
    }

    .status-active {
      color: #48bb78;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-active::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #48bb78;
      display: inline-block;
    }

    .status-inactive {
      color: #f56565;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-inactive::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #f56565;
      display: inline-block;
    }

    .chart-container {
      height: 300px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        position: relative;
        height: auto;
      }
      .main {
        margin-left: 0;
        width: 100%;
      }
    }
  </style>
  </head>

  <body>
    <div class="sidebar">
      <h1>üçø HONEYPOT</h1>
      <ul>
        <li class="active">üìä Dashboard</li>
        <li>üçØ Honeypots</li>
        <li>üìà Events</li>
        <li>‚ö†Ô∏è Threats</li>
        <li>‚öôÔ∏è Settings</li>
      </ul>
    </div>
  
    <div class="main">
      <div class="top-bar">
        <h2>Dashboard</h2>
        <div>üë§ {{ current_user.username }}</div>
      </div>
  
      <div class="cards">
        <div class="card">
          <h4>üçØ Honeypots</h4>
          <p>{{ honeypots|length }}</p>
        </div>
        <div class="card">
          <h4>üìÉ Total Events</h4>
          <p>{{ "{:,}".format(total_events) }}</p>
        </div>
        <div class="card">
          <h4>üìç Unique IPs</h4>
          <p>{{ "{:,}".format(unique_ips) }}</p>
        </div>
        <div class="card">
          <h4>‚ö†Ô∏è Threats</h4>
          <p>{{ "{:,}".format(threats) }}</p>
        </div>
      </div>
  
      <div class="section">
        <h3>Honeypots</h3>
        <table class="honeypots-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Events</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for hp in honeypots %}
            <tr>
              <td>Honey {{ hp.name }}</td>
              <td>{{ hp.type }}</td>
              <td>{{ "{:,}".format(hp.attacks|length) }}</td>
              <td class="status-{{ 'active' if hp.active else 'inactive' }}">
                {{ 'Active' if hp.active else 'Inactive' }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
  
      <div class="section">
        <h3>Events (Last 7 Days)</h3>
        <div class="chart-container">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
  
      <div class="section">
        <h3>Top Attackers / Services</h3>
        <table class="attackers-table">
          <thead>
            <tr>
              <th>Top Attackers</th>
              <th>Top Services</th>
            </tr>
          </thead>
          <tbody>
            {% for attacker in top_attackers %}
            <tr>
              <td>{{ attacker.ip_address }}</td>
              <td>{{ attacker.service }} - {{ "{:,}".format(attacker.count) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
          <div class="card-header">
            <h3>üö® Live Attack Feed</h3>
          </div>
          <div class="card-body attack-list" id="live-attack-feed">
            <!-- Attacks will appear here dynamically -->
          </div>
        </div>
  
        <div class="card">
          <div class="card-header">
              <h3>üö® Live Attack Notifications</h3>
          </div>
          <div class="card-body">
              <div id="attack-notifications"></div>
          </div>
      </div>
  

  <div class="card map-card">
    <div class="card-header">
      <h3>üåç Attack Locations</h3>
    </div>
    <div class="card-body p-0"> <!-- p-0 removes padding for full-width map -->
      <div id="attack-map"></div>
    </div>
  </div>
  
  </div>

     <!-- Add this if not already present -->
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
  <style>
    /* Add attack notification styling */
    .attack-notification {
      padding: 10px;
      margin: 5px 0;
      background: #ffebee;
      border-left: 3px solid #f44336;
    }
    .attack-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
    }
  </style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #attack-map { 
        height: 400px;
        z-index: 1; 
        border-radius: 8px;
        margin-top: 20px;
    }
    .map-attack-marker {
        background: #ff0000;
        border-radius: 50%;
        width: 10px;
        height: 10px;
    }
</style>


<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
  <script>
    // Activity Chart
    const ctx = document.getElementById('activityChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: {{ date_labels|tojson|safe }},
        datasets: [{
          label: 'Attacks',
          data: {{ attack_data|tojson|safe }},
          backgroundColor: 'rgba(255, 159, 64, 0.7)',
          borderColor: 'rgba(255, 159, 64, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      }
    });
  </script>


<!-- Add this script after Socket.IO -->


  

<script>
    const socket = io();
    const attackFeed = document.getElementById('live-attack-feed');
    
    socket.on('new_attack', (attack) => {
      const attackElement = document.createElement('div');
      attackElement.className = 'attack-notification';
      attackElement.innerHTML = `
        <p><strong>${new Date(attack.timestamp).toLocaleString()}</strong></p>
        <p><b>IP:</b> ${attack.ip}</p>
        ${attack.type === 'login_attempt' ? 
          `<p><b>Credentials:</b> ${attack.payload.username}/${attack.payload.password}</p>` : ''}
        ${attack.scanned_path ? `<p><b>Scanned:</b> ${attack.scanned_path}</p>` : ''}
        <small>${attack.user_agent}</small>
      `;
      attackFeed.prepend(attackElement);
    });

 </script>

 <script>
    // Initialize map AFTER DOM loads
    document.addEventListener('DOMContentLoaded', function() {
      const map = L.map('attack-map').setView([20, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // Custom icon
      const attackIcon = L.divIcon({
        className: 'map-attack-marker',
        iconSize: [10, 10]
      });

      // Real-time attack plotting
      socket.on('new_attack', (attack) => {
        if(attack.geo?.lat) {
          L.marker([attack.geo.lat, attack.geo.lon], {icon: attackIcon})
            .addTo(map)
            .bindPopup(`
              <b>${attack.ip}</b><br>
              ${attack.geo.country || 'Unknown'}<br>
              ${attack.type.replace('_', ' ')}
            `);
          
          // Auto-center on first attack
          if(!map._loadedFirstAttack) {
            map.setView([attack.geo.lat, attack.geo.lon], 5);
            map._loadedFirstAttack = true;
          }
        }
      });
    });
  </script>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<!-- At BOTTOM of file -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const map = L.map('attack-map').setView([20, 0], 2);
    
    // Add attribution (good practice)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Custom marker styling
    const attackIcon = L.divIcon({
        className: 'map-attack-marker',
        iconSize: [10, 10]
    });

    socket.on('new_attack', (attack) => {
      if(attack.geo?.lat) {
        L.marker([attack.geo.lat, attack.geo.lon], { icon: attackIcon })
          .addTo(map)
          .bindPopup(`<b>${attack.ip}</b><br>${attack.type}`);
      }
    });
  });
</script>
</body>
</html>
{% endblock %}